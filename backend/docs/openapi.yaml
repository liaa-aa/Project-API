openapi: 3.0.0
info:
  title: VolunteerEvent API - Sistem Manajemen Relawan Bencana
  version: 1.0.0
  description: |
    **API Dokumentasi Lengkap untuk VolunteerEvent**
    
    Sistem manajemen relawan bencana yang menyediakan:
    - Autentikasi JWT & Google OAuth
    - Manajemen pengguna dan sertifikat
    - CRUD event/bencana dengan GraphQL
    - Dashboard statistik admin
    - Integrasi cuaca OpenWeatherMap
    
    **Tech Stack:** AdonisJS v6, MongoDB, GraphQL, JWT
  contact:
    name: Tim Developer VolunteerEvent
    email: dev@volunteerevent.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3333
    description: Development Server
  - url: https://api.volunteerevent.com
    description: Production Server

paths:
  /register:
    post:
      tags:
        - Auth
      summary: Registrasi user baru
      description: Membuat akun user baru di sistem.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Registrasi berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Email sudah terdaftar atau data tidak valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Terjadi kesalahan server

  /login:
    post:
      tags:
        - Auth
      summary: Login user
      description: Melakukan autentikasi user dan mengembalikan token JWT.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Email atau password salah / akun tidak bisa login dengan password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Terjadi kesalahan server

  /google-login:
    post:
      tags:
        - Auth
      summary: Login menggunakan akun Google
      description: >
        Melakukan login menggunakan ID token Google. Backend akan memverifikasi token,
        menghubungkan ke user yang sudah ada atau membuat user baru.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - idToken
              properties:
                idToken:
                  type: string
                  description: ID token dari Google OAuth
                  example: ya29.a0AfH6SMBExampleGoogleToken
      responses:
        '200':
          description: Login Google berhasil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Token Google tidak valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Terjadi kesalahan server

  /users:
    get:
      tags:
        - Users
      summary: Mendapatkan daftar semua user (admin)
      description: >
        Mengambil seluruh data user. Hanya bisa diakses oleh admin
        (menggunakan middleware auth + admin).
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Berhasil mengambil daftar user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          description: Tidak terautentikasi (token tidak ada/tidak valid)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tidak punya hak akses (bukan admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Users
      summary: Membuat user baru (admin)
      description: >
        Membuat user baru dari sisi admin.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
      responses:
        '201':
          description: User berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Data tidak valid / email sudah digunakan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tidak punya hak akses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Mendapatkan detail user berdasarkan ID
      description: >
        Mengambil detail user berdasarkan ID. (Pada routes saat ini, endpoint ini tidak
        berada dalam group middleware auth/admin sehingga bersifat publik.)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user (MongoDB ObjectId)
      responses:
        '200':
          description: Detail user berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User tidak ditemukan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Users
      summary: Update data user berdasarkan ID (admin)
      description: Mengubah data user (misalnya name, email, password) berdasarkan ID.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user (MongoDB ObjectId)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200':
          description: User berhasil diupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tidak punya hak akses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User tidak ditemukan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
      summary: Menghapus user berdasarkan ID (admin)
      description: Menghapus user dari sistem.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user (MongoDB ObjectId)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User berhasil dihapus
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deleted successfully
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tidak punya hak akses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User tidak ditemukan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/stats:
    get:
      tags:
        - Admin Dashboard
      summary: Statistik Dashboard Admin
      description: >
        Mengambil statistik lengkap untuk dashboard admin:
        - Total pengguna terdaftar
        - Total event/bencana aktif
        - Total relawan yang disetujui
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statistik berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminStatsResponse'
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Akses ditolak (bukan admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}/certificates:
    post:
      tags:
        - Certificates
      summary: Tambah Sertifikat User
      description: >
        Menambahkan sertifikat baru ke profil user.
        User hanya bisa menambah sertifikat sendiri, admin bisa menambah ke user manapun.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user (MongoDB ObjectId)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CertificateRequest'
      responses:
        '200':
          description: Sertifikat berhasil ditambahkan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Data tidak valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Tidak diizinkan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User tidak ditemukan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}/certificates/{certId}:
    put:
      tags:
        - Certificates
      summary: Update Sertifikat
      description: Mengubah data sertifikat yang sudah ada
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user
        - in: path
          name: certId
          required: true
          schema:
            type: string
          description: ID sertifikat
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CertificateRequest'
      responses:
        '200':
          description: Sertifikat berhasil diupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Tidak terautentikasi
        '403':
          description: Tidak diizinkan
        '404':
          description: User/sertifikat tidak ditemukan

    delete:
      tags:
        - Certificates
      summary: Hapus Sertifikat
      description: Menghapus sertifikat dari profil user
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID user
        - in: path
          name: certId
          required: true
          schema:
            type: string
          description: ID sertifikat
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Sertifikat berhasil dihapus
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Tidak terautentikasi
        '403':
          description: Tidak diizinkan
        '404':
          description: User/sertifikat tidak ditemukan

  /weather:
    get:
      tags:
        - Weather
      summary: Cuaca Berdasarkan Kota
      description: Mengambil informasi cuaca dari OpenWeatherMap API berdasarkan nama kota
      parameters:
        - in: query
          name: city
          required: true
          schema:
            type: string
          description: Nama kota
          example: Jakarta
      responses:
        '200':
          description: Data cuaca berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeatherResponse'
        '400':
          description: Parameter city tidak valid
        '404':
          description: Kota tidak ditemukan
        '500':
          description: Error dari weather API

  /weather/bencana/{id}:
    get:
      tags:
        - Weather
      summary: Cuaca Lokasi Bencana
      description: Mengambil cuaca berdasarkan lokasi event bencana
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID event bencana
      responses:
        '200':
          description: Data cuaca lokasi bencana
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeatherBencanaResponse'
        '404':
          description: Event bencana tidak ditemukan
        '500':
          description: Error dari weather API

  /graphql:
    post:
      tags:
        - GraphQL
      summary: GraphQL Endpoint (Events & Volunteers)
      description: >
        **Endpoint GraphQL untuk operasi Bencana & Relawan**
        
        **Available Queries:**
        - `getBencana` - Daftar semua event bencana
        - `getBencanaById(id)` - Detail event berdasarkan ID
        - `myRegistrations` - Pendaftaran relawan user saat ini
        - `bencanaRelawan(bencanaId)` - Daftar relawan per event (admin)
        
        **Available Mutations:**
        - `createBencana` - Buat event baru (admin)
        - `updateBencana` - Update event (admin)
        - `deleteBencana` - Hapus event (admin)
        - `joinBencana` - Daftar sebagai relawan
        - `cancelJoinBencana` - Batalkan pendaftaran
        - `updateRegistrationStatus` - Update status relawan (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                  description: GraphQL query string
                  example: |
                    query {
                      getBencana {
                        id
                        title
                        location
                        type
                        date
                        maxVolunteers
                        currentVolunteers
                        photo
                      }
                    }
                variables:
                  type: object
                  nullable: true
                  example: {}
                operationName:
                  type: string
                  nullable: true
                  example: getBencana
      responses:
        '200':
          description: GraphQL response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    description: Data hasil query GraphQL
                  errors:
                    type: array
                    nullable: true
                    items:
                      type: object
                      properties:
                        message:
                          type: string
                        locations:
                          type: array
                          items:
                            type: object
                        path:
                          type: array
                          items:
                            type: string
        '401':
          description: Tidak terautentikasi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      description: Representasi user lengkap dari database
      properties:
        _id:
          type: string
          description: MongoDB ObjectId
          example: 6650d9c3f8a0c71234567890
        name:
          type: string
          description: Nama lengkap user
          example: Budi Santoso
        email:
          type: string
          format: email
          description: Email user (unique)
          example: budi@mail.com
        role:
          type: string
          enum: [admin, relawan]
          description: Role user dalam sistem
          example: relawan
        googleId:
          type: string
          description: Google OAuth ID (jika login via Google)
          example: 1234567890123456789
        certificates:
          type: array
          description: Daftar sertifikat user
          items:
            $ref: '#/components/schemas/Certificate'
        createdAt:
          type: string
          format: date-time
          description: Waktu pembuatan akun
          example: 2024-06-01T12:00:00Z
        updatedAt:
          type: string
          format: date-time
          description: Waktu update terakhir
          example: 2024-06-02T08:30:00Z

    PublicUser:
      type: object
      description: Representasi user yang dikirim ke client pada response auth
      properties:
        id:
          type: string
          example: 6650d9c3f8a0c71234567890
        name:
          type: string
          example: Budi
        email:
          type: string
          format: email
          example: budi@mail.com
        role:
          type: string
          example: admin

    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          example: Budi
        email:
          type: string
          format: email
          example: budi@mail.com
        password:
          type: string
          format: password
          example: rahasia123

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          example: User berhasil dibuat
        user:
          type: object
          properties:
            id:
              type: string
              example: 6650d9c3f8a0c71234567890
            name:
              type: string
              example: Budi
            email:
              type: string
              format: email
              example: budi@mail.com

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: budi@mail.com
        password:
          type: string
          format: password
          example: rahasia123

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: Login berhasil
        token:
          type: string
          description: JSON Web Token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        user:
          $ref: '#/components/schemas/PublicUser'

    UserCreateRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          example: Ani
        email:
          type: string
          format: email
          example: ani@mail.com
        password:
          type: string
          format: password
          example: password123

    UserUpdateRequest:
      type: object
      properties:
        name:
          type: string
          example: Ani Update
        email:
          type: string
          format: email
          example: ani_update@mail.com
        password:
          type: string
          format: password
          example: newpassword123

    AdminStatsResponse:
      type: object
      description: Response statistik dashboard admin
      properties:
        totalUsers:
          type: integer
          description: Total pengguna terdaftar
          example: 150
        totalEvents:
          type: integer
          description: Total event/bencana
          example: 25
        totalVolunteers:
          type: integer
          description: Total relawan yang disetujui
          example: 89

    Certificate:
      type: object
      description: Sertifikat user
      properties:
        _id:
          type: string
          example: 6650d9c3f8a0c71234567891
        name:
          type: string
          description: Nama sertifikat
          example: Sertifikat P3K
        provider:
          type: string
          description: Penyedia sertifikat
          example: BNSP
        dateIssued:
          type: string
          format: date
          description: Tanggal terbit
          example: 2024-01-15
        dateExpired:
          type: string
          format: date
          description: Tanggal kadaluarsa
          example: 2026-01-15
        certificateNumber:
          type: string
          description: Nomor sertifikat
          example: P3K-2024-001
        category:
          type: string
          description: Kategori sertifikat
          example: Kesehatan
        photo:
          type: string
          description: Base64 encoded image atau URL
          example: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...

    CertificateRequest:
      type: object
      description: Request untuk menambah/update sertifikat
      required:
        - name
      properties:
        name:
          type: string
          description: Nama sertifikat (wajib)
          example: Sertifikat P3K
        provider:
          type: string
          description: Penyedia sertifikat
          example: BNSP
        dateIssued:
          type: string
          format: date
          description: Tanggal terbit (YYYY-MM-DD)
          example: 2024-01-15
        dateExpired:
          type: string
          format: date
          description: Tanggal kadaluarsa (YYYY-MM-DD)
          example: 2026-01-15
        certificateNumber:
          type: string
          description: Nomor sertifikat
          example: P3K-2024-001
        category:
          type: string
          description: Kategori sertifikat
          example: Kesehatan
        photo:
          type: string
          description: Base64 encoded image
          example: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...

    WeatherResponse:
      type: object
      description: Response cuaca dari OpenWeatherMap
      properties:
        city:
          type: string
          example: Jakarta
        country:
          type: string
          example: ID
        temp:
          type: number
          description: Suhu dalam Celsius
          example: 28.5
        feelsLike:
          type: number
          description: Suhu yang dirasakan
          example: 32.1
        humidity:
          type: integer
          description: Kelembapan (%)
          example: 75
        description:
          type: string
          description: Deskripsi cuaca
          example: scattered clouds
        icon:
          type: string
          description: Icon code cuaca
          example: 03d
        windSpeed:
          type: number
          description: Kecepatan angin (m/s)
          example: 3.2

    WeatherBencanaResponse:
      type: object
      description: Response cuaca untuk lokasi bencana
      properties:
        bencana:
          type: object
          properties:
            id:
              type: string
              example: 6650d9c3f8a0c71234567892
            title:
              type: string
              example: Banjir Jakarta Selatan
            location:
              type: string
              example: Jakarta
        weather:
          $ref: '#/components/schemas/WeatherResponse'

    ErrorResponse:
      type: object
      description: Response error standar
      properties:
        message:
          type: string
          description: Pesan error
          example: Terjadi kesalahan server
        code:
          type: string
          description: Kode error (opsional)
          example: INTERNAL_ERROR
        details:
          type: object
          description: Detail tambahan error (opsional)
          example: {}